# PR Reviewer Assignment Service

## Архитектурные решения и допущения

### Публичный API

Сервис задуман как полностью открытый внутри контура: все эндпоинты доступны без авторизации и дополнительного заголовка `Authorization`. Это упрощает интеграции и соответствует текущей OpenAPI спецификации. При необходимости ограничить доступ позже достаточно будет вернуть middleware и описать security-схемы.

### Доменная модель vs API контракт

**Поле `need_more_reviewers`**
- Упоминается в описании задания и используется внутри домена (true, если ревьюверов < 2), но в публичном API/DTO не возвращается, чтобы соответствовать OpenAPI.

**Бизнес-логика**
- Автоназначение: До 2 активных ревьюверов из команды автора (исключая автора)
- Переназначение: Замена из **команды заменяемого ревьювера** (не автора)
- После merge: Изменение ревьюверов запрещено при статусе `MERGED`
- Идемпотентность: Повторные вызовы возвращают текущее состояние без ошибок

### Тестовая БД для интеграционных тестов

- В `docker-compose.yml` есть второй PostgreSQL сервис `postgres_test` (порт `5434`) специально для интеграционных тестов. 
- При поднятии стенда `docker-compose up` создаёт две базы: рабочую (`pr_reviewer_db`) и тестовую (`pr_reviewer_test_db`). 
- Это позволяет изолировать тестовые сценарии от основной БД.

## Тесты

### Интеграционные

Работают поверх реального PostgreSQL (сервис `postgres_test`) и реальных репозиториев/сервисов, но без запуска HTTP‑сервера — запросы выполняются через Gin в памяти.

```bash
docker compose up -d postgres_test
go test ./tests/integration -count=1
docker compose stop postgres_test
```

### End-to-End

E2E тесты поднимают тот же Gin router через `httptest.Server`: сервис стартует в памяти, а сценарий прогоняется реальным `net/http` клиентом. БД всё так же настоящая (`postgres_test`). При необходимости легко переключиться на dockerized `app` (см. compose файл).

```bash
docker compose up -d postgres_test
go test ./tests/e2e -count=1
docker compose stop postgres_test
```
**Про test suite-паттерн**  
Мы понимаем, что наличие `IntegrationSuite`/`E2ESuite` и общей фикстуры для TestMain — это не классическая идиома Go (обычно предпочитают простые функции и таблицы), но для небольшого учебного проекта считаем приемлемым использовать эти обёртки ради меньшего бойлерплейта и единообразия в тестах.

## Запуск через Docker Compose

`docker compose up`:
- поднимает две БД (`postgres` и `postgres_test`),
- прогоняет миграции для основной БД через сервис `migrations` (образ `migrate/migrate`),
- стартует сервис `app` только после успешных миграций. Переменные окружения читаются из `.env`, но отсутствие файла не ломает старт: можно передать значения через `env_file` или напрямую в `environment`.

При необходимости повторно применить/откатить миграции вручную можно использовать цели `make migrate-up`/`migrate-down`.
