# PR Reviewer Assignment Service

Микросервис для автоматического назначения ревьюеров на Pull Request'ы с поддержкой команд и управления активностью пользователей.

## Быстрый старт

### Требования

* Docker & Docker Compose
* Go 1.25+ (для локальной разработки)
* Make

### Запуск сервиса

1. **Клонировать репозиторий**

   ```bash
   git clone https://github.com/Magomed-cmd/pr-reviewer-assignment
   cd pr-reviewer-assignment
   ```

2. **Поднять сервис через Docker Compose**

   ```bash
   docker compose up -d
   ```

   Это автоматически:
   * поднимет PostgreSQL (основная БД + тестовая);
   * применит миграции;
   * запустит сервис на порту `8080`.

3. **Проверить работоспособность**

   ```bash
   curl http://localhost:8080/health
   ```

### Основные команды Makefile

```bash
# Запуск тестов
make test             # Все тесты
make test-integration # Интеграционные тесты
make test-e2e         # E2E-тесты

# Работа с БД
make migrate-up       # Применить миграции
make migrate-down     # Откатить миграции

# Качество кода
make lint             # Проверка линтером

# Нагрузочное тестирование
make load-test        # k6-тестирование (если настроено)

# Остановка окружения
docker compose down -v # Остановить и удалить volumes
```

## API

Сервис предоставляет REST API согласно OpenAPI-спецификации (`plan/openapi.yaml`):

* `POST /team/add` — создание/обновление команды;
* `GET /team/get` — получение команды;
* `POST /users/setIsActive` — управление активностью пользователя;
* `GET /users/getReview` — получение PR'ов, где пользователь назначен ревьювером;
* `POST /pullRequest/create` — создание PR с автоназначением ревьюверов;
* `POST /pullRequest/merge` — перевод PR в состояние `MERGED` (идемпотентно);
* `POST /pullRequest/reassign` — переназначение ревьювера.

## Архитектура

Использована гексагональная архитектура:

* `internal/core/domain` — доменные сущности и типы;
* `internal/core/services` — бизнес-логика;
* `internal/core/ports` — интерфейсы репозиториев/сервисов/транзакций;
* `internal/adapters/input/http` — HTTP-обработчики (Gin);
* `internal/adapters/output/database` — PostgreSQL-репозитории (pgx);
* `internal/infrastructure` — инициализация приложения, роутер, база, транзакции.

## Доменные правила

* При создании PR автоматически назначаются **до двух** активных ревьюверов из **команды автора**, исключая самого автора.
* Если доступных активных ревьюверов меньше двух, назначается доступное количество (1 или 2). Ситуация с 0 ревьюверами трактуется как ошибка домена (`NO_CANDIDATE`) и PR не создаётся.
* Переназначение ревьювера выполняется в пределах **команды заменяемого ревьювера**, с учётом флагов активности и уже назначенных ревьюверов.
* После перевода PR в статус `MERGED` любые попытки переназначения ревьюверов приводят к доменной ошибке `PR_MERGED`.
* Операция merge (`/pullRequest/merge`) является идемпотентной: повторный вызов возвращает актуальное состояние PR без ошибки.

## Тесты

### Интеграционные тесты

* Работают поверх реального PostgreSQL (сервис `postgres_test` на порту `5434`).
* Используют реальные репозитории и сервисы, HTTP-слой не поднимается — Gin запускается в памяти.

Запуск:

```bash
docker compose up -d postgres_test
make test-integration
```

### E2E-тесты

* Поднимают HTTP-роутер через `httptest.Server`;
* Используют реальную БД `postgres_test`;
* Проверяют полные сквозные сценарии создания/merge/переназначения PR.

Запуск:

```bash
docker compose up -d postgres_test
make test-e2e
```

## Нагрузочное тестирование

Нагрузочные сценарии описаны в `scripts/load_test/load_test.js` (k6).

Примерно полученные метрики (для ориентира):

* p95 латентности < 300 мс;
* доля успешных запросов > 99.9% при RPS, сопоставимом с требованиями задачки.

## Конфигурация и .env

Конфигурация сервиса задаётся через переменные окружения.

Пример `.env` (файл **преднастроен и включён в репозиторий**, чтобы проверяющему не приходилось ничего дописывать вручную; в реальных боевых условиях такой файл, конечно, не должен храниться в Git):

```env
DB_HOST=postgres
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=password
DB_NAME=pr_reviewer_db
DB_SSLMODE=disable

PORT=8080
GIN_MODE=debug
```

Я осознаю, что конфигурационные файлы с паролями обычно не коммитят, и в проде для этого используются секреты/хранилища. В рамках тестового задания `.env` сознательно оставлен в репозитории ради удобства запуска.
